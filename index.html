<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="English Practice">
    <title>English Conversation Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .api-key-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-content button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .level-selector {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .level-btn {
            padding: 0.5rem 1rem;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .level-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-content {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            line-height: 1.6;
            max-width: 75%;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .speak-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .mic-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .mic-btn.recording {
            animation: pulse-red 1.5s ease-in-out infinite;
            background: #f5576c;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .welcome-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .welcome-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .welcome-card p {
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f5576c;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .install-prompt {
            background: rgba(255, 243, 205, 0.95);
            padding: 1rem;
            border-bottom: 2px solid #ffc107;
            text-align: center;
        }

        .install-prompt button {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó£Ô∏è English Practice</h1>
        <button class="settings-btn" onclick="showSettings()">‚öôÔ∏è</button>
    </div>

    <div class="api-key-modal" id="apiKeyModal">
        <div class="modal-content">
            <h2>üîë Setup</h2>
            <p style="margin-bottom: 1rem;">Enter your Groq API key to start practicing English for free!</p>
            <input type="password" id="apiKeyInput" placeholder="Your Groq API Key">
            <small style="display: block; margin-bottom: 1rem;">Get it free at <a href="https://console.groq.com" target="_blank" style="color: #667eea;">console.groq.com</a></small>
            <button onclick="saveApiKey()">Save & Start</button>
        </div>
    </div>

    <div class="level-selector">
        <button class="level-btn active" data-level="beginner" onclick="setLevel('beginner')">üå± Beginner</button>
        <button class="level-btn" data-level="intermediate" onclick="setLevel('intermediate')">üìö Intermediate</button>
        <button class="level-btn" data-level="advanced" onclick="setLevel('advanced')">üéì Advanced</button>
        <button class="level-btn" data-level="conversation" onclick="setLevel('conversation')">üí¨ Free Talk</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="welcome-card">
            <h3>üëã Welcome!</h3>
            <p>I'm your English conversation partner. I'll help you practice speaking and writing in English.</p>
            <p><strong>Features:</strong></p>
            <p>üé§ Voice input (tap microphone)</p>
            <p>üîä Listen to my responses</p>
            <p>üìù Text chat when you prefer</p>
            <p>üí° I'll correct your mistakes gently</p>
            <p style="margin-top: 1rem; color: #667eea;"><strong>Tip:</strong> Select your level and start talking!</p>
        </div>
    </div>

    <div class="input-section">
        <div class="input-container">
            <button class="mic-btn" id="micBtn" onclick="toggleRecording()">üé§</button>
            <textarea 
                id="messageInput" 
                placeholder="Type or use voice..."
            ></textarea>
            <button class="send-btn" onclick="sendMessage()">üì§</button>
        </div>
    </div>

    <script>
        let apiKey = '';
        let conversationHistory = [];
        let currentLevel = 'beginner';
        let recognition = null;
        let isRecording = false;
        let synth = window.speechSynthesis;

        const LEVEL_PROMPTS = {
            beginner: `You are a friendly English teacher for beginners. Use simple words and short sentences. Speak slowly and clearly. When the student makes mistakes, gently correct them by repeating the correct form. Encourage them often. Ask simple questions to keep the conversation going.`,
            
            intermediate: `You are an English conversation partner for intermediate learners. Use everyday vocabulary and common expressions. When you notice errors, correct them naturally in your response. Introduce new vocabulary gradually. Ask follow-up questions to develop the conversation.`,
            
            advanced: `You are an English conversation partner for advanced learners. Use varied vocabulary and complex structures. Discuss abstract topics. Point out subtle mistakes in grammar or word choice. Help refine their language to sound more natural and fluent.`,
            
            conversation: `You are a casual English conversation partner. Chat naturally about any topic. Be friendly and engaging. Don't focus too much on corrections unless the meaning is unclear. Make the conversation feel natural and fun.`
        };

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                isRecording = true;
                const micBtn = document.getElementById('micBtn');
                if (micBtn) micBtn.classList.add('recording');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                stopRecording();
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopRecording();
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please enable it in Settings.');
                }
            };
            
            recognition.onend = function() {
                stopRecording();
            };
        }

        window.onload = function() {
            const savedKey = localStorage.getItem('groqApiKey');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKeyModal').style.display = 'none';
            }

            const savedHistory = localStorage.getItem('englishHistory');
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                renderHistory();
            }
        };

        function showSettings() {
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            
            if (!apiKey) {
                alert('Please enter a valid API key');
                return;
            }

            localStorage.setItem('groqApiKey', apiKey);
            document.getElementById('apiKeyModal').style.display = 'none';
            addMessage('assistant', "Great! I'm ready to chat. How are you today? üòä");
        }

        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
        }

        function toggleRecording() {
            if (!recognition) {
                alert('Voice input is not supported on this device');
                return;
            }

            if (isRecording) {
                try {
                    recognition.stop();
                } catch(e) {
                    console.log('Already stopped');
                }
                stopRecording();
            } else {
                try {
                    recognition.start();
                    isRecording = true;
                    document.getElementById('micBtn').classList.add('recording');
                } catch(e) {
                    alert('Could not start microphone. Please try again.');
                    stopRecording();
                }
            }
        }

        function stopRecording() {
            isRecording = false;
            const micBtn = document.getElementById('micBtn');
            if (micBtn) {
                micBtn.classList.remove('recording');
            }
        }

        function speakText(text) {
            if (!synth) return;
            
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            synth.speak(utterance);
        }

        function addMessage(role, content, allowSpeak = false) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            if (role === 'assistant' && allowSpeak) {
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn';
                speakBtn.textContent = 'üîä';
                speakBtn.onclick = () => speakText(content);
                contentDiv.appendChild(speakBtn);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            
            container.scrollTop = container.scrollHeight;
        }

        function renderHistory() {
            const container = document.getElementById('chatContainer');
            const welcomeCard = container.querySelector('.welcome-card');
            container.innerHTML = '';
            if (welcomeCard) container.appendChild(welcomeCard);
            
            conversationHistory.forEach(msg => {
                if (msg.role !== 'system') {
                    addMessage(msg.role, msg.content, msg.role === 'assistant');
                }
            });
        }

        async function sendMessage() {
            if (!apiKey) {
                alert('Please set up your API key first');
                showSettings();
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage('user', message);
            
            const systemPrompt = LEVEL_PROMPTS[currentLevel];
            
            if (conversationHistory.length === 0 || conversationHistory[0].role !== 'system') {
                conversationHistory.unshift({ role: 'system', content: systemPrompt });
            } else {
                conversationHistory[0].content = systemPrompt;
            }
            
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <span class="loading"></span>
                    <span class="loading" style="animation-delay: 0.2s;"></span>
                    <span class="loading" style="animation-delay: 0.4s;"></span>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(loadingDiv);

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: conversationHistory,
                        temperature: 0.8,
                        max_tokens: 500
                    })
                });

                document.getElementById('loading').remove();

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                addMessage('assistant', assistantMessage, true);
                conversationHistory.push({ role: 'assistant', content: assistantMessage });

                localStorage.setItem('englishHistory', JSON.stringify(conversationHistory));

                // Auto-speak the response
                speakText(assistantMessage);

            } catch (error) {
                document.getElementById('loading')?.remove();
                addMessage('assistant', `Sorry, there was an error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
